- Feature Name: `wyfs_ledger`
- Start Date: `24-10-2019`
- RFC PR: (leave this empty)

# Summary

This provides an overview of the ledger format used within the Whiley
Compiler for managing versioned resources.

# Motivation

In order to support incremental compilation, a mechanism is required
for storing "diffs" between files.  The chosen mechanism is that of a
ledger of "transations" which include said diffs (amongst other
things).  This document simply details the format of this ledger.

# Technical Details

*(This document employs the binary encodings used in
[RFC#14](https://github.com/Whiley/RFCs/blob/master/text/0014-binheap.md))*

A ledger is a sequence of zero or more _transactions_ of the following
form:

```
type Transaction is {
  uv version,
  uv len,
  Entry[len] entries
}
```

Each transaction has a specific _version_ identifier to allow for
multi-version ledgers.  It is expected that, in most cases, the
`version` and `len` will fit within a single byte.  For the purposes
of this document, we simply assume the version is `0` whilst
subsequent extensions may introduce new version formats.  The `len`
field identifies the number of _entries_ in the transaction:

```
type Entry is { uv type, payload }
```

The `type` field indicates the layout of the subsequent payload.  The
current values for the `type` field specified by this document are:

   * `REGISTER=0` --- `payload = { uv len, u8[len] bytes }`.  This registers a new
     key for use with subsequent operations.
   
   * `CREATE=1` --- `payload = { uv key, uv len, u8[len] bytes }`.  This creates a
     new file associated with the given key and initialised with the
     given bytes.
   
   * `REMOVE=2` --- `payload = { uv key }`.  This deletes the file associated with
     the given key.
   
   * `MOVE=3` --- `payload = { uv from_key, uv to_key }`.  This renames a given
     file (i.e. changes the key it is associated with).
   
   * `UPDATE=4` --- `payload = { uv len, Splice[len] splices }`.  This updates to
     a given file by splicing bytes in or out.

   * `METADATA=5` --- `payload = { uv len, u8[len] bytes }`.  This allows
     arbitrary meta-data to be associated witih this transaction.

Observe that, in all cases, it is an error for a key to be referenced
before it has been registered.  However, a key can be defined in the
same transaction as it is used, provided the definition occurrs before
its first use.

We note that no provision is made within this RFC for compression of
payloads.  However, it is expected that this will be specified in
subsequent updates.

# Terminology

    * _Ledger_ --- A sequence of zero or more _transactions_.

# Drawbacks and Limitations

None.

# Unresolved Issues

None.